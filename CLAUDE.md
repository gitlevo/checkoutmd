# CLAUDE.md

This is the development guide for agents working on the checkout.md codebase.

## What this project is

checkout.md is an MCP-native credential wallet. Agents request scoped, short-lived tokens instead of getting raw credentials. Policies (YAML) define access rules. Everything is logged.

## Project structure

```
src/
  cli.ts              CLI entry (commander)
  index.ts            Public API exports
  server.ts           MCP server wiring
  types.ts            All shared TypeScript types
  token-store.ts      In-memory scoped token store
  vault/              Encrypted credential storage (AES-256-GCM + Argon2id + SQLite)
  policy/             YAML policy loading + evaluation engine (CEL support)
  audit/              Append-only audit log (separate SQLite DB)
  tools/              MCP tool handlers (request, list, budget, report)
  commands/           CLI commands (init, serve, add-credential, list-credentials, audit)
tests/                Vitest test files
checkout.md           Agent instruction file (shipped with npm package + generated by init)
```

## Commands

```bash
npm run build         # TypeScript compile
npm test              # Run all tests (vitest)
npm run test:watch    # Watch mode
```

## Architecture rules

- **Two separate SQLite databases**: vault.db (encrypted credentials) and audit.db (logs). Never mix them.
- **Application-level encryption**: AES-256-GCM per credential, not SQLCipher. We control what's encrypted (values) vs queryable (names, types).
- **Scoped tokens are in-memory only**: Never persisted. Server restart invalidates all tokens.
- **Audit log is append-only**: INSERT only. No UPDATE, no DELETE.
- **Passphrase via env var for serve**: `CHECKOUT_PASSPHRASE` — stdin is consumed by MCP STDIO transport.

## Code conventions

- ESM modules (`"type": "module"` in package.json)
- All imports use `.js` extension (Node16 module resolution)
- Strict TypeScript
- Tests go in `tests/` directory, named `*.test.ts`
- No default exports — use named exports everywhere

## Testing

Run specific test file:
```bash
npx vitest run tests/vault.test.ts
```

Tests use temp SQLite databases in os.tmpdir() and clean up after themselves.

## Key dependencies

- `@modelcontextprotocol/sdk` — MCP server + stdio transport
- `better-sqlite3` — SQLite (vault + audit)
- `@node-rs/argon2` — Key derivation
- `@marcbachmann/cel-js` — CEL expression evaluation in policies
- `zod` — Schema validation for policies and MCP tool inputs
- `yaml` — Policy file parsing
- `commander` — CLI framework
